DROP DATABASE car_shop;
CREATE DATABASE car_shop;
USE car_shop;

CREATE TABLE `client` (
`id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
`name` VARCHAR(25) NOT NULL,
`surname` VARCHAR(25) DEFAULT NULL,
`phone_number` VARCHAR(25) NOT NULL,
PRIMARY KEY (`id`)
)ENGINE=INNODB DEFAULT CHARSET=utf8;

CREATE TABLE `car` (
`id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
`plate_number` VARCHAR(25) NOT NULL,
`year` YEAR(4) NOT NULL,
`color` VARCHAR(20) DEFAULT NULL,
`model` VARCHAR(20) NOT NULL,
PRIMARY KEY (id)
) ENGINE=INNODB DEFAULT CHARSET=utf8;

CREATE TABLE `advert`(
`id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
`car_id` BIGINT UNSIGNED NOT NULL,
`seller_id` BIGINT UNSIGNED NOT NULL,
`price` DOUBLE UNSIGNED NOT NULL,
`deal_id` BIGINT UNSIGNED DEFAULT NULL,
`status` ENUM('Open','Closed') DEFAULT 'Open',
PRIMARY KEY (id),
FOREIGN KEY (car_id) REFERENCES `car`(id),
FOREIGN KEY (seller_id) REFERENCES `client`(id)
) ENGINE=INNODB DEFAULT CHARSET=utf8;

DELIMITER $$
CREATE TRIGGER price_should_be_bigger_then_zero
  BEFORE INSERT ON advert
  FOR EACH ROW
    BEGIN
    IF NEW.price <= 0
    THEN SIGNAL SQLSTATE '22003' SET MESSAGE_TEXT = 'Price can not be 0 or less';
   END IF;
 END;
$$
CREATE TRIGGER price_should_be_bigger_then_zero_on_update
BEFORE UPDATE ON advert
 FOR EACH ROW
  BEGIN
    IF NEW.price <= 0
    THEN SIGNAL SQLSTATE '22003' SET MESSAGE_TEXT = 'Price can not be 0 or less';
    END IF;
  END;
 $$ 
 CREATE TRIGGER only_one_car_allow_to_insert_sale_in_one_time
 BEFORE INSERT ON advert
 FOR EACH ROW
   BEGIN
     IF NEW.status = 'Open' AND
        (SELECT COUNT(id) FROM `advert` WHERE status='Open' AND car_id = NEW.car_id) > 0
     THEN
      SIGNAL SQLSTATE '22003' SET MESSAGE_TEXT = 'Only one car can be in advert with status Open';
      END IF;
 END;
 $$
 CREATE TRIGGER only_one_car_allow_to_update_sale_in_one_time
 BEFORE UPDATE ON advert
 FOR EACH ROW
   BEGIN
     IF NEW.status = 'Open' AND
        (SELECT COUNT(id) FROM `advert` WHERE status='Open' AND car_id = NEW.car_id) > 0
     THEN
      SIGNAL SQLSTATE '22003' SET MESSAGE_TEXT = 'Only one car can be in advert with status Open';
      END IF;
 END;
 $$
DELIMITER ;

CREATE TABLE `deal` (
`id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
`buyer_id` BIGINT UNSIGNED NOT NULL,
`price` DOUBLE UNSIGNED NOT NULL,
`advert_id` BIGINT UNSIGNED NOT NULL,
`status` ENUM('Active','Rejected','Approved') DEFAULT 'Active',
PRIMARY KEY (`id`),
FOREIGN KEY (buyer_id) REFERENCES `client`(id),
FOREIGN KEY (advert_id) REFERENCES `advert`(id)
) ENGINE=INNODB  DEFAULT CHARSET=utf8;

DELIMITER $$
CREATE TRIGGER price_in_deal_should_be_bigger_then_zero
  BEFORE INSERT ON deal
  FOR EACH ROW
    BEGIN
    IF NEW.price <= 0
    THEN SIGNAL SQLSTATE '22003' SET MESSAGE_TEXT = 'Price can not be 0 or less';
   END IF;
 END;
$$
CREATE TRIGGER price_in_deal_should_be_bigger_then_zero_on_update
BEFORE UPDATE ON deal
 FOR EACH ROW
  BEGIN
    IF NEW.price <= 0
    THEN SIGNAL SQLSTATE '22003' SET MESSAGE_TEXT = 'Price can not be 0 or less';
    END IF;
  END;
 $$ 
DELIMITER ;
