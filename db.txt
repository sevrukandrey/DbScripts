DROP DATABASE car_shop;
CREATE DATABASE car_shop;
USE car_shop;

CREATE TABLE `client` (
`id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
`name` VARCHAR(25) DEFAULT NULL,
`surname` VARCHAR(25) DEFAULT NULL,
`phone_number` VARCHAR(25) NOT NULL,
UNIQUE (phone_number),
PRIMARY KEY (`id`)
)ENGINE=INNODB DEFAULT CHARSET=utf8;


CREATE TABLE `car` (
`id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
`car_number` VARCHAR(25) DEFAULT NULL,
`year` YEAR(4) DEFAULT NULL,
`color` VARCHAR(20) DEFAULT NULL,
`model` VARCHAR(20) DEFAULT NULL,
PRIMARY KEY (id)
) ENGINE=INNODB DEFAULT CHARSET=utf8;

CREATE TABLE `advert`(
`id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
`car_id` BIGINT UNSIGNED NOT NULL UNIQUE,
`seller_id` BIGINT UNSIGNED NOT NULL,
`price` DOUBLE UNSIGNED NOT NULL,
`deal_id` BIGINT UNSIGNED DEFAULT NULL,
PRIMARY KEY (id),
FOREIGN KEY (car_id) REFERENCES `car`(id),
FOREIGN KEY (seller_id) REFERENCES `client`(id)
) ENGINE=INNODB DEFAULT CHARSET=utf8;

DELIMITER $$
CREATE TRIGGER price_should_be_bigger_then_zero
  BEFORE INSERT ON advert
  FOR EACH ROW
    BEGIN
    IF NEW.price <= 0
    THEN SIGNAL SQLSTATE '22003' SET MESSAGE_TEXT = 'Price can not be 0';
   END IF;
 END;
$$
DELIMITER ;

CREATE TABLE `deal` (
`id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
`buyer_id` BIGINT UNSIGNED NOT NULL,
`price` DOUBLE UNSIGNED NOT NULL,
`advert_id` BIGINT UNSIGNED NOT NULL,
`status` ENUM('Active','Rejected','Approved') DEFAULT 'Active',
PRIMARY KEY (`id`),
FOREIGN KEY (buyer_id) REFERENCES `client`(id),
FOREIGN KEY (advert_id) REFERENCES advert(id)
) ENGINE=INNODB  DEFAULT CHARSET=utf8;

INSERT INTO `client`(NAME,surname,phone_number) VALUES ("Andrey", "Sevruk","093-774");
INSERT INTO `client`(NAME,surname,phone_number) VALUES ("Sasha", "Ivanov","100-589");
INSERT INTO `client`(NAME,surname,phone_number) VALUES ("Vova", "Petrov","789-526");
INSERT INTO `client`(NAME,surname,phone_number) VALUES ("Sasha", "Ivanov","145585");
INSERT INTO `client`(NAME,surname,phone_number) VALUES ("Tom", "Deny","32123");
INSERT INTO `client`(NAME,surname,phone_number) VALUES ("Jack", "Tomer","14532211585");

INSERT INTO `car`(car_number, year, color, model) VALUES ("AA1312AA", 2015,"black","fiesta");
INSERT INTO `car`(car_number, YEAR, color, model) VALUES ("AA9999AA", 2013,"green","x5");
INSERT INTO `car`(car_number, YEAR, color, model) VALUES ("AA7777AA", 2016,"black","rio");
INSERT INTO `car`(car_number, YEAR, color, model) VALUES ("AA5555AA", 2010,"black","c4");
INSERT INTO `car`(car_number, YEAR, color, model) VALUES ("AA1234AA", 2013,"green","x3");
INSERT INTO `car`(car_number, YEAR, color, model) VALUES ("AA4412AA", 2015,"black","golf");
INSERT INTO `car`(car_number, YEAR, color, model) VALUES ("AA4315AA", 2003,"red","c1");

INSERT INTO `advert`(car_id, seller_id, price) VALUES (1,1,2000);
INSERT INTO `advert`(car_id, seller_id, price) VALUES (2,2,3000);
INSERT INTO `advert`(car_id, seller_id, price) VALUES (3,3,3000);
INSERT INTO `advert`(car_id, seller_id, price) VALUES (4,2,3000);
INSERT INTO `advert`(car_id, seller_id, price) VALUES (6,2,3000);

INSERT INTO `deal`(buyer_id, price, advert_id) VALUES (4,3000,1);
INSERT INTO `deal`(buyer_id, price, advert_id) VALUES (5,3500,1);
INSERT INTO `deal`(buyer_id, price, advert_id) VALUES (6,8000,3);
INSERT INTO `deal`(buyer_id, price, advert_id) VALUES (6,9000,5);




INSERT INTO `advert`(car_id, seller_id) VALUES (1,3);
INSERT INTO `client`(NAME,surname,phone_number) VALUES ("123", "3333","145585");



SELECT MAX(d.price), a.car_id 
FROM `deal` AS d 
JOIN `advert` AS a ON 
d.advert_id = a.`advert_id`
WHERE d.status = "Active"
GROUP BY d.advert_id

SELECT Max(d.`price`), a.`car_id`
FROM `advert` AS a
JOIN `deal` AS d
ON 
a.deal_id = d.id
WHERE a.deal_id Is Not Null


SELECT c.year,COUNT(c.year) AS year_count
 FROM advert AS a JOIN car AS c ON
  a.car_id = c.id 
  WHERE a.deal_id IS NOT NULL
  GROUP BY c.year
  ORDER BY year_count
  DESC Limit 1
